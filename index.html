<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <title>Instagram Crawler</title>
  <link rel="stylesheet" href="./style.css">
  <style>
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Instagram Crawler</h1>
    <div class="search-container">
      <input type="text" id="username" class="search-input" placeholder="Enter Instagram username or link" />
      <button id="searchButton" class="search-button">Search</button>
    </div>
    <div id="status"></div>
    <div id="grid"></div>
  </div>

  <script>
    document.getElementById("searchButton").addEventListener("click", function () {
      const username = document.getElementById("username").value.trim();

      if (!username) {
        document.getElementById("status").innerText = "Please enter a username!";
        document.getElementById("status").classList.add("error");
        return;
      }

      const statusEl = document.getElementById("status");
      const gridEl = document.getElementById("grid");
      const buttonEl = document.getElementById("searchButton");

      // Reset UI
      buttonEl.disabled = true;
      statusEl.innerText = "Searching...";
      statusEl.classList.remove("error");
      gridEl.innerHTML = "";

      //const eventSource = new EventSource(`http://localhost:3000/search?username=${encodeURIComponent(username)}`);
      const eventSource = new EventSource(`https://zonal-integrity/railway.app/search?username=${encodeURIComponent(username)}`);
      let dataReceived = false;

      eventSource.onmessage = function (event) {
        const data = JSON.parse(event.data);
        console.log("Backend Response:", data);
        dataReceived = true;

        if (data.error) {
          statusEl.innerText = `Error: ${data.error}`;
          statusEl.classList.add("error");
          eventSource.close();
          buttonEl.disabled = false;
          return;
        }

        if (data.message) {
          statusEl.innerText = data.message;
        }

        if (Array.isArray(data.data)) {
          const result = {
            bioData: {},
            allPosts: []
          };

          // Extract bio information (from the first div in the array)
          data.data.forEach((postHTML, index) => {
            const tempDiv = document.createElement("div");
            tempDiv.innerHTML = postHTML.trim();
            const postNode = tempDiv.firstChild;

            // Extract profile info only once (from the first post, for instance)
            if (postNode.classList.contains("user-info") && Object.keys(result.bioData).length === 0) {
              const bioData = {};

              // Extract profile image
              const imgEl = postNode.querySelector(".avatar__image");
              if (imgEl) {
                bioData.profile_pic = imgEl.getAttribute("src");
              }

              // Extract username
              const usernameEl = postNode.querySelector(".user-info__username-text");
              if (usernameEl) {
                bioData.user_name = usernameEl.innerText.trim();
              }
               const usernameFullEl = postNode.querySelector(".user-info__full-name");
              if (usernameFullEl) {
                bioData.user_full_name = usernameFullEl.innerText.trim();
              }

              const userBioGraphy = postNode.querySelector(".user-info__biography");
              if (userBioGraphy) {
                bioData.user_bio_graphy = userBioGraphy.innerText.trim();
              }

              // Extract stats (posts, followers, following)
              const statEls = postNode.querySelectorAll(".stats__item");
              statEls.forEach(stat => {
                const key = stat.querySelector(".stats__name")?.innerText.trim().toLowerCase();
                const value = stat.querySelector(".stats__value")?.innerText.trim();
                if (key && value) {
                  bioData[key] = value;
                }
              });

              result.bioData = bioData;
            }

            // Process media content for each post
            const mediaItems = postNode.querySelectorAll(".profile-media-list__item");
            mediaItems.forEach(mediaItem => {
              const postData = {};

              // Extract image URL
              const imageEl = mediaItem.querySelector(".media-content__image");
              if (imageEl) {
                postData.imageUrl = imageEl.getAttribute("src");
              }

              // Extract caption
              const captionEl = mediaItem.querySelector(".media-content__caption");
              if (captionEl) {
                postData.caption = captionEl.innerText.trim();
              }

              // Extract download link for image or video
              const downloadLinkEl = mediaItem.querySelector(".button--filled.button__download");
              if (downloadLinkEl) {
                const downloadLink = downloadLinkEl.getAttribute("href");
                if (downloadLink.endsWith(".jpg") || downloadLink.endsWith(".png") || downloadLink.endsWith(".gif")) {
                  postData.playImageUrl = downloadLink;
                } else if (downloadLink.endsWith(".mp4")) {
                  postData.playVideoUrl = downloadLink;
                }
              }

              // Extract likes and comments
              const metaEl = mediaItem.querySelector(".media-content__meta");
              const likesEl = metaEl.querySelector(".media-content__meta-like");
              const commentsEl = metaEl.querySelector(".media-content__meta-comment");
              const timeEl = metaEl.querySelector(".media-content__meta-time");

              postData.likes = likesEl ? likesEl.innerText.trim() : "";
              postData.comments = commentsEl ? commentsEl.innerText.trim() : "";

              const timeTitle = timeEl ? timeEl.getAttribute("title") : "";
              const [date, time] = timeTitle.split(",").map(item => item.trim());
              postData.date = date;
              postData.time = time;
              postData.uploadTime = timeEl ? timeEl.innerText.trim() : "";

              result.allPosts.push(postData);
            });
          });

          console.log("Extracted Data Object:", result);
            const bioData = result.bioData;
            const allPosts = result.allPosts;
               var videoLinks = " ";
            allPosts.forEach((post, index) => {
                if ('playVideoUrl' in post) {
                    console.log(`Post ${index + 1} - Video URL: ${post.playVideoUrl}`);
                    videoLinks += `
                        <div class="col-md-4 mb-2">
                            <video  controls>
                                <source src="${post.playVideoUrl}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                        </div>
                    `


                } else if ('playImageUrl' in post) {
                    console.log(`Post ${index + 1} - Image URL: ${post.playImageUrl}`);
                     videoLinks +=`
                        <div class="col-md-4 mb-2">
                            <img src=" ${post.imageUrl}" alt="image 1"
                                class="w-100 rounded-3">
                        </div>
                    `
                } 
            });

          // Optionally display result in UI as a formatted object
          const resultDiv = document.createElement("div");
          resultDiv.classList.add("post");
          resultDiv.innerHTML =`<section class="h-100 gradient-custom-2">
                                            <div class="container py-5 h-100">
                                              <div class="row d-flex justify-content-center">
                                                <div class="col col-lg-9 col-xl-8">
                                                  <div class="card">
                                                    <div class="rounded-top text-white d-flex flex-row" style="background-color: #000;">
                                                      <div class="ms-4 mt-5 d-flex flex-column" style="width: 150px;">
                                                        <img src="${bioData.profile_pic}"
                                                          alt="Generic placeholder image" class="img-fluid img-thumbnail mt-4 mb-2"
                                                          style="width: 150px; z-index: 1">
                                                      
                                                      </div>
                                                      <div class="ms-3" style="margin-top: 130px;">
                                                        <h5>${bioData.user_full_name}</h5>
                                                        <p>${bioData.user_bio_graphy}</p>
                                                      </div>
                                                    </div>
                                                    <div class="p-4 text-black bg-body-tertiary">
                                                      <div class="d-flex justify-content-end text-center py-1 text-body">
                                                        <div>
                                                          <p class="mb-1 h5">${bioData.posts}</p>
                                                          <p class="small text-muted mb-0">Posts</p>
                                                        </div>
                                                        <div class="px-3">
                                                          <p class="mb-1 h5">${bioData.followers}</p>
                                                          <p class="small text-muted mb-0">Followers</p>
                                                        </div>
                                                        <div>
                                                          <p class="mb-1 h5">${bioData.following}</p>
                                                          <p class="small text-muted mb-0">Following</p>
                                                        </div>
                                                      </div>
                                                    </div>
                                                    <div class="card-body p-4 text-black">
                                                      <div class="d-flex justify-content-between align-items-center mb-4 text-body">
                                                        <p class="lead fw-normal mb-0">Posts</p>
                                                        <p class="mb-0"></p>
                                                      </div>
                                                      <div class="row g-2">
                                                        ${videoLinks}
                                                      </div>
                                                    </div>
                                                  </div>
                                                </div>
                                              </div>
                                            </div>
                                          </section>`;
          gridEl.appendChild(resultDiv);
        }

        if (data.finished) {
          eventSource.close();
          buttonEl.disabled = false;
          statusEl.innerText = "Done.";
        }
      };

      eventSource.onerror = function (event) {
        if (!dataReceived) {
          console.error("Stream error:", event);
          statusEl.innerText = "Error occurred while crawling.";
          statusEl.classList.add("error");
        }
        eventSource.close();
        buttonEl.disabled = false;
      };
    });
  </script>
</body>
</html>
